name: Repo Audit (Size & Junk)

on:
  workflow_dispatch:
  pull_request:
    branches: [ "**" ]

permissions:
  contents: read
  pull-requests: write

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Repo Audit (Phase A)
        run: |
          mkdir -p scripts audit_out
          if [ ! -f scripts/repo_audit.sh ]; then
            echo "Missing scripts/repo_audit.sh"
            exit 1
          fi
          TOP_N=25 BIG_FILE_MB=1 bash scripts/repo_audit.sh audit_out

      - name: Upload audit artifact
        uses: actions/upload-artifact@v4
        with:
          name: repo-audit
          path: audit_out/repo-audit.md

      - name: Comment audit summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'audit_out/repo-audit.md';
            const body = fs.existsSync(path)
              ? fs.readFileSync(path, 'utf8').slice(0, 6000) + "\n\n(Truncated in comment; see artifact for full report.)"
              : "Audit report not found.";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: "## Repo Audit Report\n\n" + body
            });
